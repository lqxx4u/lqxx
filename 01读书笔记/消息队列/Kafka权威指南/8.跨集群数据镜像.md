
## 8. 跨集群数据镜像
### 1. 使用场景
>区域集群和中心集群
>
>冗余
>
>云迁移

### 2. 多集群架构
#### 2.1跨数据中心通信
高延迟、有限的带宽、高成本

增加重试次数、增大缓冲区

####架构原则：
	每个数据中心至少有一个集群
	每两个数据中心之间的数据复制要做到每个事件仅复制一次（除非出现错误需要重试）
	如果有可能，尽量从远程数据中心读取数据，而不是向远程数据中心写入数据。
#### 2.2Hub和Spoke架构
适用于一个中心Kafka集群对应多个本地Kafka集群的情况

#### 2.3双活架构
多个数据中心共享数据并且每个中心都可以生产和读取数据

问题在于如何进行多个位置的数据异步读取和异步更新时避免冲突、避免循环镜像

增加头部信息，头部信息包含源数据中心的信息，以此避免循环镜像。

也可以使用结构化的数据格式来实现，并用它在数据里添加标签和头部信息

#### 2.4主备架构
失效备援
##### 1数据丢失和不一致性
如果多个主题数据之间有相关性，在失效备援过程中一些数据及时到达灾备集群，而有些则不能。切换灾备集群之后，应用程序需要知道如何处理没有相关信息的产品数据。
##### 2失效备援之后的起始偏移量
偏移量自动重置：配置一下在没有上一个提交偏移量的情况下，消费者从头还是尾读取数据

复制偏移量主题：消费者把偏移量提交到 _consumer_offsets的主题上（0.9之后）
>会造成数据重复。

基于时间的失效备援
>消息里包含时间戳（0.10.0版本之后）
>
>实现：可以指定时间点开始处理数据

偏移量外部映射
自己开发，同时保存主集群和灾备集群的偏移量。

##### 3在失效备援之后
改动主集群，如把主集群当做备集群

解决：清理旧的主集群，删掉所有数据和偏移量，然后从新的主集群上把数据镜像回来。
##### 4关于集群发现
如何与灾备集群通信

	大多数组织为此创建了DNS别名，将其指向主集群
	使用服务发现工具，如Zookeeper


#### 2.5延展集群
单个集群同步复制其他数据中心的数据

缺点：只能应对数据中心的故障，无法应对应用程序或者kafka故障。运维复杂